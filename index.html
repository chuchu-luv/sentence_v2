<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ì˜¨ë… ë„ì„œ íƒ€ìì—°ìŠµ -ë¬¸ì¥ë²„ì „-</title>

  <!-- í°íŠ¸ ë¡œë“œ -->
  <style>
    @font-face {
      font-family: 'ONE Mobile POP';
      src: url('./ONE Mobile POP.ttf') format('truetype');
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: 'Hakgyoansim Badasseugi';
      src: url('./Hakgyoansim Badasseugi TTF L.ttf') format('truetype');
      font-weight: 400;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: 'Hakgyoansim Badasseugi';
      src: url('./Hakgyoansim Badasseugi TTF B.ttf') format('truetype');
      font-weight: 700;
      font-style: normal;
      font-display: swap;
    }
    @font-face {
      font-family: 'BMJUA';
      src: url('https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2001@1.0/BMJUA.woff') format('woff');
      font-weight: normal;
      font-style: normal;
      font-display: swap;
    }
  </style>

  <!-- ì „ì²´ ìŠ¤íƒ€ì¼ -->
  <style>
    :root{
      --panel: #ffffff;
      --border: #C9C9C9;
      --ink: #1f2a44;
      --muted: #8c93a8;
      --chip: #f4f7ff;
      --primary: #ff7b7b;
      --secondary: #6bd3ff;
      --success: #2fb579;
      --danger: #ff5a5a;
      --warning: #ffb84d;
      --magenta: #ff78c6;
      --violet: #9f87ff;
      --shadow: 0 18px 40px rgba(18, 28, 49, 0.18);
      --inner: 0 1px 0 rgba(255,255,255,.8) inset, 0 -1px 0 rgba(0,0,0,.04) inset;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; overflow-y:auto; overflow-x:hidden; }

    @keyframes gradientShift{
      0%   {background-position:0 0, 100% 0, 0% 50%}
      50%  {background-position:-60px -30px, 110% -40px, 100% 50%}
      100% {background-position:0 0, 100% 0, 0% 50%}
    }
    body{
      margin:0;
      color:var(--ink);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      background:
        radial-gradient(80vmax 50vmax at 20% -10%, rgba(255,232,243,0.9) 0%, rgba(255,232,243,0) 65%),
        radial-gradient(70vmax 50vmax at 100% 0%, rgba(234,247,255,0.9) 0%, rgba(234,247,255,0) 65%),
        linear-gradient(45deg, #FFEFF5, #FFF8E4, #F3FAFF, #F0ECFF, #F7FFE9);
      background-size: 120% 120%, 120% 120%, 400% 400%;
      background-position: 0 0, 100% 0, 0% 50%;
      background-repeat:no-repeat;
      animation: gradientShift 12s ease-in-out infinite;
      font-family:'Hakgyoansim Badasseugi','BMJUA','Noto Sans KR',system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
      letter-spacing:.2px;
      font-size:20px;
    }

    .container{
      max-width:1200px;
      margin:0 auto;
      padding:16px 24px;
      min-height:100vh;
      display:flex;
      flex-direction:column;
      gap:12px;
    }

    .title{
      font-family:'ONE Mobile POP','BMJUA','Noto Sans KR',system-ui,-apple-system,'Segoe UI',Roboto,Helvetica,Arial,sans-serif;
      text-align:center;
      line-height:1.05;
      margin:2px 0 0;
      font-size:clamp(40px,6.5vw,76px);
      background:linear-gradient(90deg,#ff7b7b,#ffb84d,#6bd3ff,#9f87ff);
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
    }
    .subtitle{
      text-align:center;
      font-size:24px;
      color:var(--muted);
      margin:2px 0 6px;
      font-weight:700;
      font-family:'Hakgyoansim Badasseugi','BMJUA','Noto Sans KR',sans-serif;
    }

    .card-title{ font-size:22px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; line-height:1.25; text-align:center; font-family:'Hakgyoansim Badasseugi','BMJUA','Noto Sans KR',sans-serif; font-weight:700; }
    .card-stars{ font-size:16px; color:#ffb84d; font-weight:800; letter-spacing:.2px; text-align:center; line-height:1.2; }
    .card-ondok{ font-size:16px; color:#6a4cff; font-weight:800; letter-spacing:.2px; }
    .book-card{
      background:var(--panel); border:2px solid var(--border); border-radius:18px; box-shadow:var(--shadow);
      padding:12px; display:flex; flex-direction:column; gap:8px; cursor:pointer; transition:transform .18s ease, box-shadow .18s ease, filter .18s ease; align-items:center; text-align:center;
    }
    .book-card:hover{ background:#F8F7FF; transform:translateY(-8px); box-shadow:0 18px 50px rgba(18,28,49,.28); }
    .book-card.selected{ background:#F7E8FF; border-color:#C9C9C9; box-shadow:0 20px 52px rgba(143,120,255,.22); }

    .start-wrap{ display:flex; justify-content:center; margin:24px 0 8px; }
    .start-big{
      min-width:320px; height:76px; font-size:28px; border-radius:18px; border:2px solid var(--border); box-shadow:var(--shadow);
      background:#ECE8FF; color:var(--ink); transition:transform .12s ease, filter .12s ease, box-shadow .12s ease;
      font-family:'ONE Mobile POP','BMJUA','Noto Sans KR',sans-serif; font-weight:400;
    }
    .start-big:disabled{ opacity:.65; cursor:not-allowed; }
    .start-big.on{ background:#ECE8FF; color:var(--ink); cursor:pointer; box-shadow:0 16px 40px rgba(143,120,255,.35), 0 0 0 2px rgba(143,120,255,.25) inset; }
    .start-big.on:hover{ transform:translateY(-2px); filter:brightness(1.05); }

    .panel{
      background:var(--panel); border:2px solid var(--border); border-radius:22px; box-shadow:var(--shadow);
      padding:16px; display:flex; flex-direction:column; gap:12px; flex:1; min-height:0;
    }

    .head-grid{ display:grid; grid-template-columns:160px minmax(280px,1fr) 380px; gap:16px; align-items:center; }
    .cover{ width:160px; height:200px; object-fit:cover; border:2px solid var(--border); border-radius:16px; box-shadow:var(--inner); background:#fff; }
    .book-meta{ display:flex; flex-direction:column; gap:8px; }
    .book-title{ font-size:30px; line-height:1.2; font-weight:700; }
    .book-author{ font-size:20px; color:var(--muted); }
    .ondok-line{ font-size:26px; margin-top:2px; }
    .ondok-line strong{ font-size:34px; color:var(--ink); }

    .stats-fixed{ display:grid; grid-template-columns:repeat(2,1fr); grid-auto-rows:1fr; gap:12px; }
    .chip{ background:var(--chip); border:2px solid var(--border); border-radius:14px; padding:14px; text-align:center; display:flex; flex-direction:column; justify-content:center; box-shadow:var(--inner); }
    .chip .lbl{ display:block; font-size:18px; color:var(--muted); margin-bottom:6px; font-family:'Hakgyoansim Badasseugi','BMJUA','Noto Sans KR',sans-serif; font-weight:700; }
    .chip .val{ font-size:28px; color:var(--success); font-family:'Hakgyoansim Badasseugi','BMJUA','Noto Sans KR',sans-serif; font-weight:700; }

    .target{
      background:#fff; border:2px solid var(--border); border-radius:16px; padding:16px; min-height:110px; line-height:2.1; font-size:26px; color:var(--ink); box-shadow:var(--inner); word-break:keep-all;
    }
    .target .ok{ color:var(--success); font-weight:700; }
    .target .err{ color:#c73939; text-decoration:underline; text-decoration-thickness:2px; text-underline-offset:4px; font-weight:700; }
    .target .next{ color:var(--ink); font-weight:900; text-decoration:none; }

    .target .kw{ color:#007bff !important; font-weight:900; }
    .target .ok.kw{ color:#007bff !important; text-decoration:none; }
    .target .err.kw{ color:#007bff !important; text-decoration:underline; text-decoration-thickness:2px; text-underline-offset:4px; }
    .target .next.kw{ color:#007bff !important; text-decoration:none; }

    .row{ display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    #typing{ flex:1; font-family:inherit; font-size:26px; padding:16px; border-radius:16px; border:2px solid var(--border); outline:none; background:#FFF8F7; color:var(--ink); box-shadow:var(--inner); }

    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px; cursor:pointer; user-select:none; padding:14px 18px; border-radius:14px; border:2px solid var(--border); text-decoration:none; font-size:20px; box-shadow:var(--shadow);
      transition:transform .12s ease, box-shadow .12s ease, filter .12s ease; font-family:'Hakgyoansim Badasseugi','BMJUA','Noto Sans KR',sans-serif; font-weight:700;
    }
    .btn:hover{ filter:brightness(1.05); transform:translateY(-1px); }
    .btn.success{ background:#DBEEFF; color:var(--ink); }
    .btn.danger{ background:#FFDBDB; color:var(--ink); }
    .btn.primary{ background:linear-gradient(180deg,var(--primary),#ff9866); color:#fff; }
    .btn.secondary{ background:linear-gradient(180deg,var(--secondary),#49b6ff); color:#fff; }
    .btn.pink{ background:linear-gradient(180deg,var(--magenta),#ff9fde); color:#fff; }
    .btn.neutral{ background:linear-gradient(180deg,#eef3fb,#d6e0f3); color:var(--ink); }

    .nextbox{ background:#fff; border:2px solid var(--border); border-radius:12px; padding:12px; box-shadow:var(--inner); }
    .nextbox .lbl{ font-size:18px; color:var(--muted); margin-bottom:6px; display:block; }
    .nextbox .sent{ font-size:20px; color:var(--muted); font-family:'Hakgyoansim Badasseugi','BMJUA','Noto Sans KR',sans-serif; font-weight:400; word-break:keep-all; }

    .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.25); display:none; align-items:center; justify-content:center; z-index:10; }
    .overlay.show{ display:flex; }
    .pause-box{ background:#fff; border:2px solid var(--border); border-radius:16px; box-shadow:var(--shadow); padding:24px; text-align:center; width:min(520px,92vw); font-size:18px; }

    .modal{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,6,20,0.35); backdrop-filter:blur(4px); z-index:20; }
    .modal.show{ display:flex; }
    .modal-card{ background:#E8F8FF; border:2px solid var(--border); border-radius:18px; box-shadow:0 18px 50px rgba(24,36,56,.28); width:min(640px,94vw); padding:24px; }
    .modal-title{ font-size:34px; margin:2px 0 10px; color:var(--success); text-align:center; letter-spacing:.5px; font-weight:800; }
    .modal-msg{ text-align:center; font-size:20px; color:#4b5563; margin-bottom:14px; font-weight:700; }
    .modal-grid{ display:grid; grid-template-columns:repeat(2,1fr); gap:14px; margin-bottom:16px; }
    .modal-grid .chip{ background:var(--chip); }
    .modal-grid .chip .val{ color:var(--warning); font-size:26px; font-family:'Hakgyoansim Badasseugi','BMJUA','Noto Sans KR',sans-serif; font-weight:700; }
    .modal-actions{ display:flex; gap:12px; justify-content:center; flex-wrap:wrap; }
    .help{ font-size:16px; color:var(--muted); margin-top:10px; text-align:center; }
  </style>
</head>

<body>
  <div id="app"></div>

  <!-- ì¼ì‹œì •ì§€ ì˜¤ë²„ë ˆì´ -->
  <div id="pauseOverlay" class="overlay" aria-hidden="true">
    <div class="pause-box">
      <div style="font-size:22px; color:var(--ink); margin-bottom:8px">ì¼ì‹œ ì •ì§€</div>
      <div class="help">ê³„ì†í•˜ë ¤ë©´ ì•„ë˜ ë²„íŠ¼ì„ ëˆ„ë¥´ê±°ë‚˜ Esc í‚¤ë¥¼ ëˆ„ë¥´ì„¸ìš”.</div>
      <div style="display:flex; gap:8px; justify-content:center; margin-top:12px; flex-wrap:wrap;">
        <button class="btn secondary" id="resumeBtn">ê³„ì†í•˜ê¸°</button>
        <button class="btn primary" id="toSelectBtn">ì²˜ìŒìœ¼ë¡œ</button>
      </div>
    </div>
  </div>

  <!-- ê²°ê³¼ íŒì—… -->
  <div id="resultModal" class="modal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-title">ì™„ë£Œ!</div>
      <div id="mMsg" class="modal-msg">ì˜í–ˆì–´ìš”! ê³„ì† ê°€ë³¼ê¹Œìš”? ğŸ‘</div>

      <div class="modal-grid">
        <div class="chip">
          <span class="lbl">ì†Œìš”ì‹œê°„(ì´ˆ)</span>
          <span id="mTime" class="val">0</span>
        </div>
        <div class="chip">
          <span class="lbl">ì…ë ¥ê¸€ì(íƒ€ìˆ˜)</span>
          <span id="mChars" class="val">0</span>
        </div>
        <div class="chip">
          <span class="lbl">ì •í™•ë„(%)</span>
          <span id="mAcc" class="val">0</span>
        </div>
        <div class="chip">
          <span class="lbl">íƒ€ì ì†ë„(íƒ€/ë¶„)</span>
          <span id="mSpeed" class="val">0</span>
        </div>
      </div>

      <div class="help">ì™„ë£Œ ë²„íŠ¼ / Enter: ë‹¤ìŒ ë¬¸ì¥ Â· ESC: ë‹¤ì‹œí•˜ê¸°</div>

      <div class="modal-actions">
        <button class="btn success" id="keepBtn">ê³„ì†í•˜ê¸°</button>
        <button class="btn danger" id="redoBtn">ë‹¤ì‹œí•˜ê¸°</button>
      </div>
    </div>
  </div>

  <script>
  'use strict';

  /* ---------- ë„ìš°ë¯¸ ---------- */
  function $(sel){ return document.querySelector(sel); }
  function $all(sel){ return Array.prototype.slice.call(document.querySelectorAll(sel)); }
  function setText(sel, text){ var el = $(sel); if(el){ el.textContent = String(text); } }
  function addClass(sel, cls){ var el = $(sel); if(el){ el.classList.add(cls); el.setAttribute('aria-hidden','false'); } }
  function removeClass(sel, cls){ var el = $(sel); if(el){ el.classList.remove(cls); el.setAttribute('aria-hidden','true'); } }
  function escapeHTML(str){
    return String(str).replace(/[&<>"']/g, function(s){
      return ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[s]);
    });
  }
  function trimTrailingSpaces(s){
    s = String(s||'');
    var i = s.length;
    while(i>0 && s.charAt(i-1)===' ') i--;
    return s.slice(0,i);
  }

  /* ---------- ë¬¸ìì—´ diff & í†µê³„ ---------- */
  function alignOps(target, typed){
    var n = target.length;
    var m = typed.length;
    var dp = new Array(n+1);
    for(var i=0;i<=n;i++){ dp[i] = new Array(m+1); }
    for(var i2=0;i2<=n;i2++){ dp[i2][0] = i2; }
    for(var j2=0;j2<=m;j2++){ dp[0][j2] = j2; }
    for(var i3=1;i3<=n;i3++){
      for(var j3=1;j3<=m;j3++){
        var cost = (target.charAt(i3-1) === typed.charAt(j3-1)) ? 0 : 1;
        var del = dp[i3-1][j3] + 1;
        var ins = dp[i3][j3-1] + 1;
        var sub = dp[i3-1][j3-1] + cost;
        dp[i3][j3] = Math.min(del, ins, sub);
      }
    }
    var ops = [];
    var i4 = n, j4 = m;
    while(i4>0 || j4>0){
      if(i4>0 && j4>0){
        var costDiag = (target.charAt(i4-1) === typed.charAt(j4-1)) ? 0 : 1;
        if(dp[i4][j4] === dp[i4-1][j4-1] + costDiag){
          ops.push({ op:'diag', match:(costDiag===0), ch:target.charAt(i4-1) });
          i4--; j4--; continue;
        }
      }
      if(i4>0 && dp[i4][j4] === dp[i4-1][j4] + 1){
        ops.push({op:'del', ch:target.charAt(i4-1)});
        i4--; continue;
      }
      if(j4>0 && dp[i4][j4] === dp[i4][j4-1] + 1){
        ops.push({op:'ins', ch:typed.charAt(j4-1)});
        j4--; continue;
      }
      if(i4>0){
        ops.push({op:'del', ch:target.charAt(i4-1)});
        i4--;
      } else {
        ops.push({op:'ins', ch:typed.charAt(j4-1)});
        j4--;
      }
    }
    ops.reverse();
    return ops;
  }

  function diffMarkup(target, typed, kwMask){
    var ops = alignOps(target, typed||'');
    var out = '';
    var pos = 0;
    for(var k=0;k<ops.length;k++){
      var o = ops[k];
      if(o.op === 'diag'){
        var cls1 = o.match ? 'ok' : 'err';
        if(kwMask && kwMask[pos]) cls1 += ' kw';
        out += '<span class="' + cls1 + '">' + escapeHTML(o.ch) + '</span>';
        pos++;
      }else if(o.op === 'del'){
        var cls2 = 'next';
        if(kwMask && kwMask[pos]) cls2 += ' kw';
        out += '<span class="' + cls2 + '">' + escapeHTML(o.ch) + '</span>';
        pos++;
      }else if(o.op === 'ins'){
        // ì¶”ê°€ íƒ€ì(ì˜¤íƒ€ë¡œ ë” ì¹œ ê¸€ì)ëŠ” í™”ë©´ì—” ì•ˆ ë³´ì„
      }
    }
    return out;
  }

  function calcCpm(charCount, seconds){
    var secs = Math.max(0, seconds||0);
    var mins = secs / 60;
    return mins>0 ? Math.round(charCount / mins) : 0;
  }

  function calcAccuracy(target, typed){
    target = target || '';
    typed = trimTrailingSpaces(typed || '');
    if(target.length===0 && typed.length===0) return 100;
    var ops = alignOps(target, typed);
    var match = 0; var errors = 0;
    for(var k=0;k<ops.length;k++){
      var o = ops[k];
      if(o.op === 'diag'){
        if(o.match) match++; else errors++;
      }else if(o.op === 'del' || o.op === 'ins'){
        errors++;
      }
    }
    var total = match + errors;
    if(total===0) return 0;
    return Math.max(0, Math.min(100, Math.round((match/total)*100)));
  }

  function calcAccuracyLive(target, typed){
    target = target || '';
    typed = trimTrailingSpaces(typed || '');
    if(typed.length===0) return 0;
    var ops = alignOps(target, typed);
    var consumed = 0, correct = 0, errors = 0;
    for(var k=0; k<ops.length && consumed < typed.length; k++){
      var o = ops[k];
      if(o.op === 'diag'){
        consumed++;
        if(o.match) correct++; else errors++;
      }else if(o.op === 'ins'){
        consumed++;
        errors++;
      }
    }
    var total = correct + errors;
    if(total===0) return 0;
    return Math.max(0, Math.min(100, Math.round((correct/total)*100)));
  }

  function feedback(acc, speed){
    if(acc===100 && speed>=200) return 'ë¸Œë¼ë³´! ì •ë§ ì˜í•˜ê³  ìˆì–´ìš”! âœ¨';
    if(acc>=95)  return 'ì™„ë²½ì— ê°€ê¹Œì›Œìš”! ğŸ‘';
    if(acc>=85)  return 'ì¢‹ì•„ìš”! ì§‘ì¤‘ë ¥ì„ ìœ ì§€í•´ìš”! ğŸ’ª';
    return 'ì²œì²œíˆ, í•˜ì§€ë§Œ ì •í™•í•˜ê²Œ! ğŸ˜Š';
  }

  /* ---------- CSV íŒŒì„œ ---------- */
  function csvToRows(text){
    var rows = [];
    var row = [];
    var cell = '';
    var inQuotes = false;
    for(var i=0;i<text.length;i++){
      var ch = text[i];
      if(inQuotes){
        if(ch === '"'){
          if(text[i+1] === '"'){
            cell += '"';
            i++;
          }else{
            inQuotes = false;
          }
        }else{
          cell += ch;
        }
      }else{
        if(ch === '"'){ inQuotes = true; }
        else if(ch === ','){ row.push(cell); cell = ''; }
        else if(ch === '\n'){ row.push(cell); rows.push(row); row = []; cell = ''; }
        else if(ch === '\r'){ /* ignore CR */ }
        else{ cell += ch; }
      }
    }
    row.push(cell);
    rows.push(row);
    return rows.filter(function(r){ return !(r.length===1 && String(r[0]).trim()===''); });
  }

  function parseSentencesCSV(text){
    text = String(text||'').replace(/^\uFEFF/, '');
    var rows = csvToRows(text);
    if(rows.length===0) return [];

    var hdr = rows[0].map(function(c){ return String(c||'').trim().toLowerCase(); });
    var hasHeader = false;
    for(var h=0; h<hdr.length; h++){
      if(
        hdr[h]==='ë¬¸ì¥' || hdr[h]==='sentence' || hdr[h]==='text' ||
        hdr[h]==='í‚¤ì›Œë“œ' || hdr[h]==='keyword' || hdr[h]==='key' ||
        hdr[h]==='order' || hdr[h]==='ìˆœì„œ' || hdr[h]==='ë²ˆí˜¸'
      ){ hasHeader = true; break; }
    }

    var sentenceCol = -1, keywordCol = -1, orderCol = -1;
    if(hasHeader){
      for(var c=0;c<rows[0].length;c++){
        var name = hdr[c];
        if(name==='ë¬¸ì¥' || name==='sentence' || name==='text') sentenceCol = c;
        if(name==='í‚¤ì›Œë“œ' || name==='keyword' || name==='key')  keywordCol  = c;
        if(name==='order' || name==='ìˆœì„œ' || name==='ë²ˆí˜¸')      orderCol    = c;
      }
    }

    var start = hasHeader ? 1 : 0;
    var tmp = [];

    for(var r=start; r<rows.length; r++){
      var row = rows[r];
      if(!row || row.length===0) continue;

      var sentence = '';
      if(sentenceCol>=0){ sentence = String(row[sentenceCol]||''); }
      else if(row.length===1){ sentence = String(row[0]||''); }
      else { sentence = String(row[row.length-1]||''); }
      sentence = sentence.trim();
      if(!sentence) continue;

      var keyword = '';
      if(keywordCol>=0){ keyword = String(row[keywordCol]||'').trim(); }

      var orderVal = r;
      if(orderCol>=0){
        var raw = Number(String(row[orderCol]).replace(/[^0-9-]+/g,''));
        if(!Number.isNaN(raw)){ orderVal = raw; }
      }

      tmp.push({ order: orderVal, text: sentence, keyword: keyword });
    }

    if(tmp.length && orderCol>=0){
      tmp.sort(function(a,b){ return (a.order||0)-(b.order||0); });
    }

    return tmp.map(function(x){ return { text:x.text, keyword:x.keyword||'' }; });
  }

  function buildKeywordMask(text, keyword){
    var mask = new Array(String(text||'').length).fill(false);
    if(!keyword) return mask;
    var toks = String(keyword).split(/[|,\s]+/).filter(Boolean);
    for(var t=0;t<toks.length;t++){
      var tok = toks[t];
      if(!tok) continue;
      var idx = 0;
      while(true){
        idx = text.indexOf(tok, idx);
        if(idx === -1) break;
        for(var j=idx; j<idx+tok.length && j<mask.length; j++){ mask[j] = true; }
        idx = idx + Math.max(1, tok.length);
      }
    }
    return mask;
  }

  /* ---------- NEW: ì…”í”Œ ---------- */
  function shuffleInPlace(arr){
    for(var i = arr.length - 1; i > 0; i--){
      var j = Math.floor(Math.random() * (i + 1));
      var tmp = arr[i]; arr[i] = arr[j]; arr[j] = tmp;
    }
    return arr;
  }

  /* ---------- CSV íŒŒì¼ë“¤ ---------- */
  const CSV_FILES = {
    hedgehog: 'sentences_hedgehog.csv',
    complain: 'sentences_complain.csv',
    fake:     'sentences_fake.csv',
    monster:  'sentences_monster.csv'
  };

  /* ---------- ì±… ì •ë³´ ---------- */
  var BOOKS = [
    { id:'hedgehog', title:'ë¯¸ì›€ì„ íŒŒëŠ” ê³ ìŠ´ë„ì¹˜', stars:'â˜…â˜†â˜†', author:'ìŠ¬ë¼ë¹„ ìŠ¤í† ì—í”„', ondok:238, cover:'covers/hedgehog.jpg',
      sentences:[ {text:'ê³ ìŠ´ë„ì¹˜ê°€ ì§§ê²Œ ëŒ€ë‹µí•˜ë”ë‹ˆ ì„¤ëª…ì„ ë§ë¶™ì˜€ì–´.', keyword:'ì„¤ëª…'}, {text:'ì¤‘ìš”í•œ íšŒì˜ë‚˜ ì¶•í•˜ í–‰ì‚¬ê°€ ìˆì„ ë•Œ ì´ìš©í•˜ëŠ” ê³³ì´ì—ˆì–´.', keyword:'ì´ìš©'} ] },
    { id:'complain', title:'ë¶ˆë§Œì™• ë½‘ê¸°ëŒ€íšŒ', stars:'â˜…â˜…â˜†', author:'ì •ë³µí˜„Â·ì´ê°‘ê·œ', ondok:294, cover:'covers/complain.jpg',
      sentences:[ {text:'ì¼ê¸°ì— ê·¸ ë‚´ìš©ì„ ì ë‹¤ ë§ê³  ë‹¤ì‹œ í•œë²ˆ ì˜ìƒì„ ëŒë ¤ ë´¤ì–´.', keyword:'ë‚´ìš©'}, {text:'ëˆ„ì—ì— ëŒ€í•´ì„œ ì˜ ëª¨ë¥´ëŠ” ì‹œì²­ìë¥¼ ìœ„í•´ ì†Œê°œ ì¢€ í•´ ì£¼ì‹¤ê¹Œìš”?', keyword:'ì†Œê°œ'} ] },
    { id:'fake', title:'ê°€ì§œ ë‰´ìŠ¤ë¥¼ ì‹œì‘í•˜ê² ìŠµë‹ˆë‹¤', stars:'â˜…â˜…â˜†', author:'ê¹€ê²½ì˜¥', ondok:269, cover:'covers/fake.jpg',
      sentences:[ {text:'ê²°ê³¼ë³´ë‹¤ ë…¸ë ¥í•˜ëŠ” ê³¼ì •ì´ ì†Œì¤‘í•œ ê±°ì–ì•„ìš”.', keyword:'ê²°ê³¼'}, {text:'ì˜ëª»í•˜ë©´ ê°„ì ‘ ê´‘ê³ ê°€ ë˜ë‹ˆê¹Œìš”.', keyword:'ê°„ì ‘'} ] },
    { id:'monster', title:'ëª¬ìŠ¤í„° ì°¨ì¼ë“œ', stars:'â˜…â˜…â˜…', author:'ì´ì¬ë¬¸', ondok:333, cover:'covers/monster.jpg',
      sentences:[ {text:'ì•„ì €ì”¨ëŠ” ìš°ë¦¬ë¥¼ 2ì¸µ ì—°êµ¬ì‹¤ë¡œ ì•ˆë‚´í–ˆë‹¤.', keyword:'ì•ˆë‚´'}, {text:'ê³µë¶€ë„, í•™êµìƒí™œë„ ì˜í•  ìˆ˜ ìˆë„ë¡ ì„±ì‹¤íˆ ì§€ë„í•˜ê² ìŠµë‹ˆë‹¤.', keyword:'ì§€ë„'} ] }
  ];

  /* ---------- ì „ì²´ ìƒíƒœ ---------- */
  var state = {
    screen: 'select',
    currentBook: null,
    sentenceIndex: 0,
    target: '',
    keyword: '',
    kwMask: [],
    startedAt: 0,
    timerId: null,
    seconds: 0,
    isPaused: false,
    finished: false,
    finishing: false
  };

  var app = $('#app');

  /* ---------- CSV ë¶ˆëŸ¬ì˜¤ê¸° ---------- */
  async function loadSentencesFor(bookId){
    const file = CSV_FILES[bookId];
    if(!file) return [];
    try{
      const res = await fetch(file, { cache:'no-store' });
      if(!res.ok) throw new Error('HTTP '+res.status);
      const txt = await res.text();
      return parseSentencesCSV(txt);
    }catch(err){
      console.warn('[CSV] load failed for', bookId, err);
      return [];
    }
  }

  /* ---------- í™”ë©´ ë Œë”ë§: ì„ íƒ í™”ë©´ ---------- */
  function renderSelect(){
    state.screen = 'select';
    clearTimer();

    app.innerHTML = `
      <div class="container">
        <h1 class="title">ì˜¨ë… ë„ì„œ íƒ€ìì—°ìŠµ -ë¬¸ì¥ë²„ì „-</h1>
        <div class="subtitle">ì›í•˜ëŠ” ì±…ì„ ê³ ë¥´ê³  ì‹œì‘í•˜ì„¸ìš”!</div>

        <div style="display:grid; grid-template-columns:repeat(auto-fit,minmax(230px,1fr)); gap:16px;">
          ${BOOKS.map(function(b){
            return `
              <div class="book-card" data-id="${b.id}">
                <img class="cover" src="${b.cover}" alt="${b.title} í‘œì§€"/>
                <div class="card-title">${b.title}</div>
                <div class="card-stars">ë‚œì´ë„ ${b.stars}</div>
                <div style="font-size:16px; color: var(--muted);">${b.author}</div>
                <div class="card-ondok">ì˜¨ë…ì§€ìˆ˜ ${b.ondok}</div>
              </div>
            `;
          }).join('')}
        </div>

        <div class="start-wrap">
          <button class="start-big" id="startBig" disabled>ì‹œì‘í•˜ê¸°</button>
        </div>
      </div>
    `;

    var selectedId = null;
    var cards = $all('.book-card');
    var startBig = $('#startBig');

    cards.forEach(function(card){
      card.addEventListener('click', function(){
        cards.forEach(function(c){ c.classList.remove('selected'); });
        card.classList.add('selected');
        selectedId = card.getAttribute('data-id');
        if(startBig){ startBig.disabled = false; startBig.classList.add('on'); }
      });
    });

    if(startBig){
      startBig.addEventListener('click', function(){
        if(!selectedId) return;
        var book = BOOKS.find(function(x){ return x.id === selectedId; });
        if(book){ startGame(book); }
      });
    }

    window.onkeydown = null;
  }

  /* ---------- ê²Œì„ ì‹œì‘ ---------- */
  async function startGame(book){
    state.currentBook = Object.assign({}, book);

    var loaded = await loadSentencesFor(book.id);
    if(Array.isArray(loaded) && loaded.length){
      state.currentBook.sentences = loaded;
    }else{
      state.currentBook.sentences = book.sentences || [];
    }

    // NEW: ì‹œì‘í•  ë•Œ ë§¤ ë¼ìš´ë“œë§ˆë‹¤ ë‹¤ë¥¸ ìˆœì„œë¥¼ ìœ„í•´ í•œë²ˆ ì„ìŒ
    shuffleInPlace(state.currentBook.sentences);

    state.sentenceIndex = 0;
    prepareSentence();
    renderGame();
    focusInputSoon();
  }

  /* ---------- í˜„ì¬ ë¬¸ì¥ ì¤€ë¹„ ---------- */
  function prepareSentence(){
    var list = state.currentBook.sentences || [];
    var idx = state.sentenceIndex % (list.length || 1);
    var item = list[idx] || { text:'', keyword:'' };

    state.target   = item.text || '';
    state.keyword  = item.keyword || '';
    state.kwMask   = buildKeywordMask(state.target, state.keyword);

    state.seconds   = 0;
    state.startedAt = 0;
    state.isPaused  = false;
    state.finished  = false;
    state.finishing = false;

    clearTimer();
  }

  function getNextSentence(){
    var list = state.currentBook.sentences || [];
    if(!list.length) return '';
    var nextIdx = (state.sentenceIndex + 1) % list.length;
    var nextItem = list[nextIdx] || { text:'' };
    return nextItem.text || '';
  }

  /* ---------- í™”ë©´ ë Œë”ë§: ê²Œì„ í™”ë©´ ---------- */
  function renderGame(){
    state.screen = 'game';
    var b = state.currentBook;

    app.innerHTML = `
      <div class="container">
        <h1 class="title">ì˜¨ë… ë„ì„œ íƒ€ìì—°ìŠµ -ë¬¸ì¥ë²„ì „-</h1>

        <section class="panel">
          <div class="head-grid">
            <img class="cover" src="${b.cover}" alt="í‘œì§€"/>
            <div class="book-meta">
              <div class="book-title">${b.title}</div>
              <div class="book-author">${b.author}</div>
              <div class="ondok-line">ì˜¨ë…ì§€ìˆ˜ <strong>${b.ondok}</strong>
                <span style="color:#ffb84d; font-weight:700; font-size:22px; margin-left:6px;">ë‚œì´ë„ ${b.stars}</span>
              </div>
            </div>

            <div class="stats-fixed">
              <div class="chip">
                <span class="lbl">ì‹œê°„(ì´ˆ)</span>
                <span id="s-time" class="val">0</span>
              </div>
              <div class="chip">
                <span class="lbl">ê¸€ì ìˆ˜</span>
                <span id="s-chars" class="val">0</span>
              </div>
              <div class="chip">
                <span class="lbl">ì •í™•ë„(%)</span>
                <span id="s-acc" class="val">0</span>
              </div>
              <div class="chip">
                <span class="lbl">íƒ€ìì†ë„(íƒ€/ë¶„)</span>
                <span id="s-speed" class="val">0</span>
              </div>
            </div>
          </div>

          <div id="target" class="target" style="margin-top:6px"></div>

          <div class="row">
            <input id="typing"
              type="text"
              inputmode="text"
              autocomplete="off"
              autocapitalize="off"
              spellcheck="false"
              placeholder="ì—¬ê¸°ì— ì…ë ¥â€¦ (ì™„ë£Œ ë²„íŠ¼ ë˜ëŠ” Enter)" />

            <button class="btn success" id="finishBtn" title="ê²°ê³¼ë³´ê¸°">âœ… ì™„ë£Œ</button>
            <button class="btn secondary" id="pauseBtn" title="ì¼ì‹œ ì •ì§€(P)">â¸ ì¼ì‹œì •ì§€</button>
          </div>

          <div class="nextbox">
            <span class="lbl">ë‹¤ìŒ ë¬¸ì¥ ë¯¸ë¦¬ë³´ê¸°</span>
            <div id="nextSentence" class="sent"></div>
          </div>

          <div class="row" style="justify-content:flex-end">
            <button class="btn neutral" id="restartBook">ë‹¤ì‹œí•˜ê¸°</button>
            <button class="btn pink" id="backBtn">ì²˜ìŒìœ¼ë¡œ</button>
          </div>
        </section>
      </div>
    `;

    updateTargetHighlight('');
    setText('#nextSentence', getNextSentence());
    renderStats('');

    var typing = $('#typing');
    if(typing){
      typing.addEventListener('input', onType);
      typing.addEventListener('keydown', onKey); // keyupì€ ì‚¬ìš© ì•ˆ í•¨
    }

    var finishBtn = $('#finishBtn');
    if(finishBtn){ finishBtn.addEventListener('click', function(){ finishSentence(); }); }

    var pauseBtn = $('#pauseBtn');
    if(pauseBtn){ pauseBtn.addEventListener('click', togglePause); }

    var restartBook = $('#restartBook');
    if(restartBook){ restartBook.addEventListener('click', function(){ hideModal(); restartCurrent(); }); }

    var backBtn = $('#backBtn');
    if(backBtn){ backBtn.addEventListener('click', function(){ hideModal(); renderSelect(); }); }

    var resumeBtn = $('#resumeBtn');
    if(resumeBtn){ resumeBtn.onclick = function(){ if(state.isPaused){ togglePause(); } }; }

    var toSelectBtn = $('#toSelectBtn');
    if(toSelectBtn){ toSelectBtn.onclick = function(){ hidePause(); renderSelect(); }; }

    var keepBtn = $('#keepBtn');
    if(keepBtn){ keepBtn.onclick = function(){ hideModal(); nextSentence(); }; }

    var redoBtn = $('#redoBtn');
    if(redoBtn){ redoBtn.onclick = function(){ hideModal(); restartCurrent(); }; }

    state.startedAt = 0;
    state.seconds   = 0;
    state.finished  = false;
    state.finishing = false;
    clearTimer();
    focusInputSoon();

    window.onkeydown = function(ev){
      if($('#resultModal').classList.contains('show')){
        if (ev.isComposing) return;
        if(ev.key === 'Enter' || ev.key === 'Return'){
          ev.preventDefault();
          hideModal();
          nextSentence();
          return;
        }
        if(ev.key === 'Escape'){
          ev.preventDefault();
          hideModal();
          restartCurrent();
          return;
        }
      }

      if(state.screen !== 'game') return;

      if(String(ev.key).toLowerCase() === 'p'){
        ev.preventDefault();
        togglePause();
        return;
      }

      if(ev.key === 'Escape'){
        ev.preventDefault();
        hideModal();
        renderSelect();
        return;
      }
    };
  }

  /* ---------- UI ì—…ë°ì´íŠ¸ ---------- */
  function updateTargetHighlight(currentTyped){
    var html = diffMarkup(state.target, currentTyped || '', state.kwMask);
    var el = $('#target');
    if(el){ el.innerHTML = html; }
  }

  function renderStats(currentTyped){
    currentTyped = String(currentTyped||'');
    var nowAcc = calcAccuracyLive(state.target, currentTyped);
    var chars = trimTrailingSpaces(currentTyped).length;
    var spd = calcCpm(chars, state.seconds);

    setText('#s-time', state.seconds);
    setText('#s-chars', chars);
    setText('#s-acc', nowAcc);
    setText('#s-speed', spd);
  }

  function startTimerIfNeeded(typedVal){
    if(state.startedAt===0 && typedVal.length>0 && !state.isPaused && !state.finished){
      state.startedAt = Date.now();
      state.timerId = setInterval(tickTimer, 1000);
    }
  }

  function tickTimer(){
    if(state.isPaused || state.finished) return;
    if(state.startedAt>0){
      state.seconds = Math.floor((Date.now() - state.startedAt)/1000);
    }
    var typingEl = $('#typing');
    var val = typingEl ? typingEl.value || '' : '';
    renderStats(val);
  }

  function clearTimer(){
    if(state.timerId){ clearInterval(state.timerId); }
    state.timerId = null;
  }

  /* ---------- ì¼ì‹œì •ì§€ / ê²°ê³¼ëª¨ë‹¬ ---------- */
  function togglePause(){
    if(state.finished) return;
    var typing = $('#typing');
    if(!state.isPaused){
      state.isPaused = true;
      showPause();
      clearTimer();
      if(typing){ typing.disabled = true; }
    }else{
      state.isPaused = false;
      hidePause();
      if(typing){ typing.disabled = false; }
      state.startedAt = Date.now() - state.seconds*1000;
      state.timerId = setInterval(tickTimer,1000);
      focusInputSoon();
    }
  }
  function showPause(){ addClass('#pauseOverlay','show'); }
  function hidePause(){ removeClass('#pauseOverlay','show'); }

  function showModal(stats){
    addClass('#resultModal','show');
    setText('#mMsg',   stats.msg);
    setText('#mTime',  stats.time);
    setText('#mChars', stats.chars);
    setText('#mAcc',   stats.acc);
    setText('#mSpeed', stats.speed);
  }
  function hideModal(){ removeClass('#resultModal','show'); }

  /* ---------- ë¬¸ì¥ ì™„ë£Œ/ì¬ì‹œì‘ ---------- */
  function focusInputSoon(){
    setTimeout(function(){
      var typing = $('#typing');
      if(typing && !typing.disabled){ typing.focus(); }
    },30);
  }

  function onKey(ev){
    if (ev.isComposing) return;
    if(ev.key === 'Enter' || ev.key === 'Return'){
      ev.preventDefault();
      if (state.finishing || state.finished) return;
      state.finishing = true;
      setTimeout(function(){
        finishSentence();
        state.finishing = false;
      }, 0);
    }
  }

  function finishSentence(){
    if(state.finished) return;
    var typing = $('#typing');
    if(!typing) return;

    var val = trimTrailingSpaces(typing.value || '');
    clearTimer();

    if(state.startedAt>0){
      state.seconds = Math.floor((Date.now()-state.startedAt)/1000);
    } else {
      state.seconds = 0;
    }

    var finalAcc   = calcAccuracy(state.target, val);
    var chars      = val.length;
    var finalSpeed = calcCpm(chars, state.seconds);
    var msg        = feedback(finalAcc, finalSpeed);

    updateTargetHighlight(val);
    typing.disabled = true;
    state.finished = true;

    showModal({ msg:msg, time:state.seconds, chars:chars, acc:finalAcc, speed:finalSpeed });
  }

  function nextSentence(){
    var list = state.currentBook.sentences || [];
    var len = list.length || 1;

    state.sentenceIndex++;

    // NEW: ë¦¬ìŠ¤íŠ¸ë¥¼ í•œ ë°”í€´ ë‹¤ ì“°ë©´ ì¦‰ì‹œ ë‹¤ì‹œ ì„ê³  0ë²ˆë¶€í„° ì‹œì‘
    if(state.sentenceIndex >= len){
      shuffleInPlace(state.currentBook.sentences);
      state.sentenceIndex = 0;
    }

    prepareSentence();

    var typing = $('#typing');
    if(typing){
      typing.disabled = false;
      typing.value = '';
    }

    setText('#nextSentence', getNextSentence());
    updateTargetHighlight('');
    renderStats('');
    focusInputSoon();
  }

  function restartCurrent(){
    // ë‹¤ì‹œí•˜ê¸°ë¥¼ ëˆŒë €ì„ ë•Œë„ ìƒˆë¡œ ì„ê³  ì²˜ìŒë¶€í„° í•  ìˆ˜ ìˆê²Œ í•˜ë ¤ë©´ ì•„ë˜ ë‘ ì¤„ ìœ ì§€
    shuffleInPlace(state.currentBook.sentences);
    state.sentenceIndex = 0;

    prepareSentence();
    var typing = $('#typing');
    if(typing){
      typing.disabled = false;
      typing.value = '';
    }
    updateTargetHighlight('');
    setText('#nextSentence', getNextSentence());
    renderStats('');
    focusInputSoon();
  }

  function onType(ev){
    var typing = ev.target;
    var val = typing.value || '';
    startTimerIfNeeded(val);
    updateTargetHighlight(val);
    renderStats(val);
  }

  /* ---------- ì‹¤í–‰ ì‹œì‘ ---------- */
  renderSelect();
  </script>
</body>
</html>
